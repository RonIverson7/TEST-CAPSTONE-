import React from 'react';
import { SafeAreaView, StyleSheet, View, Text, ScrollView, TouchableOpacity, ActivityIndicator, Alert, TextInput, RefreshControl, Modal, FlatList } from 'react-native';
import Header from '../components/Header';
import { Ionicons } from '@expo/vector-icons';
import { useEffect, useMemo, useState } from 'react';
import { useRouter } from 'expo-router';
import { useUser } from '../contexts/UserContext';
import { supabase } from "../../supabase/supabaseClient";
import * as Linking from 'expo-linking';
import { useSafeAreaInsets } from 'react-native-safe-area-context';

const API_BASE = "http://192.168.18.22:3000/api";

const CheckoutScreen = () => {
  const router = useRouter();
  const { userData } = useUser();
  const insets = useSafeAreaInsets();

  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [accessToken, setAccessToken] = useState(null);
  const [refreshToken, setRefreshToken] = useState(null);

  const [cartItems, setCartItems] = useState([]);
  const [savedAddresses, setSavedAddresses] = useState([]);
  const [selectedAddress, setSelectedAddress] = useState(null);

  const [selectedShipping, setSelectedShipping] = useState('standard');
  const [selectedPayment, setSelectedPayment] = useState('card');
  const [orderNotes, setOrderNotes] = useState('');

  // Address modal & form state (mirrors web AddressModal)
  const [showAddressModal, setShowAddressModal] = useState(false);
  const [formLoading, setFormLoading] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [regions, setRegions] = useState([]);
  const [provinces, setProvinces] = useState([]);
  const [citiesMunicipalities, setCitiesMunicipalities] = useState([]);
  const [barangays, setBarangays] = useState([]);
  const [formData, setFormData] = useState({
    fullName: '',
    email: '',
    phoneNumber: '',
    alternatePhone: '',
    addressLine1: '',
    addressLine2: '',
    landmark: '',
    regionCode: '',
    provinceCode: '',
    cityMunicipalityCode: '',
    barangayCode: '',
    regionName: '',
    provinceName: '',
    cityMunicipalityName: '',
    barangayName: '',
    postalCode: '',
    addressType: 'home',
    isDefault: false,
    deliveryInstructions: ''
  });
  const [openSelect, setOpenSelect] = useState({ region: false, province: false, city: false, barangay: false });

  const shippingOptions = [
    { id: 'standard', name: 'Standard Shipping', description: '5-7 business days', price: 100 },
    { id: 'express', name: 'Express Shipping', description: '2-3 business days', price: 250 },
    { id: 'priority', name: 'Priority Shipping', description: 'Next business day', price: 500 },
  ];

  const paymentMethods = [
    { id: 'card', name: 'Credit/Debit Card', description: 'Visa, Mastercard, Amex' },
    { id: 'gcash', name: 'GCash', description: 'Digital wallet payment' },
    { id: 'bank', name: 'Bank Transfer', description: 'Direct bank payment' },
    { id: 'cod', name: 'Cash on Delivery', description: 'Pay when you receive' },
  ];

  const fetchCart = async (at, rt) => {
    try {
      const res = await fetch(`${API_BASE}/marketplace/cart`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Cookie': `access_token=${at || ''}; refresh_token=${rt || ''}`,
        },
      });
      const result = await res.json();
      if (!res.ok || !result?.success) return;
      const items = result?.data?.items || [];
      const mapped = items.map((item) => ({
        id: item.cartItemId,
        cartItemId: item.cartItemId,
        marketItemId: item.marketplace_items?.marketItemId,
        title: item.marketplace_items?.title || 'Unknown',
        price: item.marketplace_items?.price || 0,
        quantity: item.quantity || 1,
        image: item.marketplace_items?.images?.[0] ? { uri: item.marketplace_items.images[0] } : null,
        artist: item.marketplace_items?.sellerProfiles?.shopName || 'Unknown Shop',
        sellerId: item.marketplace_items?.userId,
        sellerProfileId: item.marketplace_items?.sellerProfileId,
      }));
      setCartItems(mapped);
    } catch (e) {
      console.warn('[checkout.js] fetchCart error', e?.message || e);
    }
  };

  // Address modal lifecycle
  useEffect(() => {
    if (showAddressModal) {
      const prefill = () => {
        if (userData) {
          setFormData(prev => ({
            ...prev,
            fullName: `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || prev.fullName,
            email: userData.email || prev.email,
          }));
        }
      };
      prefill();
      fetchRegions();
    }
  }, [showAddressModal, userData]);

  const fetchRegions = async () => {
    try {
      setFormLoading(true);
      const res = await fetch('https://psgc.gitlab.io/api/regions/');
      const data = await res.json();
      setRegions(Array.isArray(data) ? data : []);
    } catch (e) {
      console.warn('regions fetch error', e?.message || e);
    } finally {
      setFormLoading(false);
    }
  };

  const fetchProvinces = async (regionCode) => {
    if (!regionCode) return;
    try {
      setFormLoading(true);
      const res = await fetch(`https://psgc.gitlab.io/api/regions/${regionCode}/provinces/`);
      const data = await res.json();
      setProvinces(Array.isArray(data) ? data : []);
    } catch (e) {
      console.warn('provinces fetch error', e?.message || e);
    } finally {
      setFormLoading(false);
    }
  };

  const fetchCitiesMunicipalities = async (provinceCode) => {
    if (!provinceCode) return;
    try {
      setFormLoading(true);
      const res = await fetch(`https://psgc.gitlab.io/api/provinces/${provinceCode}/cities-municipalities/`);
      const data = await res.json();
      setCitiesMunicipalities(Array.isArray(data) ? data : []);
    } catch (e) {
      console.warn('cities fetch error', e?.message || e);
    } finally {
      setFormLoading(false);
    }
  };

  const fetchBarangays = async (cityMunicipalityCode) => {
    if (!cityMunicipalityCode) return;
    try {
      setFormLoading(true);
      const res = await fetch(`https://psgc.gitlab.io/api/cities-municipalities/${cityMunicipalityCode}/barangays/`);
      const data = await res.json();
      setBarangays(Array.isArray(data) ? data : []);
    } catch (e) {
      console.warn('barangays fetch error', e?.message || e);
    } finally {
      setFormLoading(false);
    }
  };

  // Cascading resets
  const onSelectRegion = (code) => {
    setFormData(prev => ({ ...prev, regionCode: code, provinceCode: '', cityMunicipalityCode: '', barangayCode: '' }));
    setProvinces([]); setCitiesMunicipalities([]); setBarangays([]);
    fetchProvinces(code);
    setOpenSelect(s => ({ ...s, region: false, province: true }));
  };
  const onSelectProvince = (code) => {
    setFormData(prev => ({ ...prev, provinceCode: code, cityMunicipalityCode: '', barangayCode: '' }));
    setCitiesMunicipalities([]); setBarangays([]);
    fetchCitiesMunicipalities(code);
    setOpenSelect(s => ({ ...s, province: false, city: true }));
  };
  const onSelectCity = (code) => {
    setFormData(prev => ({ ...prev, cityMunicipalityCode: code, barangayCode: '' }));
    setBarangays([]);
    fetchBarangays(code);
    setOpenSelect(s => ({ ...s, city: false, barangay: true }));
  };
  const onSelectBarangay = (code) => {
    setFormData(prev => ({ ...prev, barangayCode: code }));
    setOpenSelect(s => ({ ...s, barangay: false }));
  };

  const validateAddressForm = () => {
    if (!formData.fullName?.trim()) return 'Full name is required';
    if (!formData.email?.trim()) return 'Email is required';
    if (!formData.phoneNumber?.trim()) return 'Phone number is required';
    if (!formData.addressLine1?.trim()) return 'Street address is required';
    if (!formData.regionCode) return 'Region is required';
    if (!formData.provinceCode) return 'Province is required';
    if (!formData.cityMunicipalityCode) return 'City/Municipality is required';
    if (!formData.barangayCode) return 'Barangay is required';
    if (!/^[0-9]{4}$/.test(String(formData.postalCode || ''))) return 'Postal code must be 4 digits';
    return '';
  };

  const saveAddress = async () => {
    const error = validateAddressForm();
    if (error) { Alert.alert('Invalid Form', error); return; }
    try {
      setIsSubmitting(true);
      const selRegion = regions.find(r => r.code === formData.regionCode);
      const selProv = provinces.find(p => p.code === formData.provinceCode);
      const selCity = citiesMunicipalities.find(c => c.code === formData.cityMunicipalityCode);
      const selBrgy = barangays.find(b => b.code === formData.barangayCode);

      const addressData = {
        ...formData,
        regionName: selRegion?.name || '',
        provinceName: selProv?.name || '',
        cityMunicipalityName: selCity?.name || '',
        barangayName: selBrgy?.name || '',
      };

      const res = await fetch(`${API_BASE}/marketplace/addresses`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Cookie': `access_token=${accessToken || ''}; refresh_token=${refreshToken || ''}`,
        },
        body: JSON.stringify(addressData),
      });
      const result = await res.json();
      if (!res.ok) throw new Error(result?.error || 'Failed to save address');

      // Refresh addresses and select default/first
      await fetchAddresses(accessToken, refreshToken);
      setShowAddressModal(false);
      Alert.alert('Success', 'Address saved successfully');
    } catch (e) {
      Alert.alert('Error', e?.message || 'Failed to save address');
    } finally {
      setIsSubmitting(false);
    }
  };

  const fetchAddresses = async (at, rt) => {
    try {
      const res = await fetch(`${API_BASE}/marketplace/addresses`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Cookie': `access_token=${at || ''}; refresh_token=${rt || ''}`,
        },
      });
      const result = await res.json();
      if (!res.ok || !result?.success) return;
      const list = result?.data || [];
      setSavedAddresses(list);
      const def = list.find(a => a.isDefault);
      if (def) setSelectedAddress(def.userAddressId);
      else if (list.length) setSelectedAddress(list[0].userAddressId);
    } catch (e) {
      console.warn('[checkout.js] fetchAddresses error', e?.message || e);
    }
  };

  useEffect(() => {
    const init = async () => {
      try {
        const { data } = await supabase.auth.getSession();
        const at = data?.session?.access_token || null;
        const rt = data?.session?.refresh_token || null;
        setAccessToken(at);
        setRefreshToken(rt);
        setLoading(true);
        await Promise.all([
          fetchCart(at, rt),
          fetchAddresses(at, rt),
        ]);
      } finally {
        setLoading(false);
      }
    };
    init();
  }, [userData]);

  const onRefresh = async () => {
    setRefreshing(true);
    try {
      await Promise.all([
        fetchCart(accessToken, refreshToken),
        fetchAddresses(accessToken, refreshToken),
      ]);
    } finally {
      setRefreshing(false);
    }
  };

  const getSubtotal = useMemo(() => () => cartItems.reduce((t, i) => t + (Number(i.price || 0) * Number(i.quantity || 0)), 0), [cartItems]);
  const getShippingCost = useMemo(() => () => (shippingOptions.find(o => o.id === selectedShipping)?.price || 0), [selectedShipping]);
  const getTotal = useMemo(() => () => getSubtotal() + getShippingCost(), [getSubtotal, getShippingCost]);

  const placeOrder = async () => {
    if (!selectedAddress) {
      Alert.alert('Missing address', 'Please select a delivery address');
      return;
    }
    try {
      setLoading(true);
      const address = savedAddresses.find(a => a.userAddressId === selectedAddress);
      const orderData = {
        shipping_address: {
          fullName: address?.fullName,
          phone: address?.phoneNumber || address?.phone,
          street: address?.addressLine1 || address?.street,
          barangay: address?.barangayName || address?.barangay,
          city: address?.cityMunicipalityName || address?.city,
          province: address?.provinceName || address?.province,
          postalCode: address?.postalCode,
          landmark: address?.landmark || '',
        },
        contact_info: {
          name: `${userData?.firstName || ''} ${userData?.lastName || ''}`.trim(),
          email: userData?.email || '',
          phone: address?.phoneNumber || address?.phone || '',
        },
        payment_method: selectedPayment,
        shipping_method: selectedShipping,
        order_notes: orderNotes,
      };

      const res = await fetch(`${API_BASE}/marketplace/orders/create`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Cookie': `access_token=${accessToken || ''}; refresh_token=${refreshToken || ''}`,
        },
        body: JSON.stringify(orderData),
      });
      const result = await res.json();
      if (!res.ok) {
        throw new Error(result?.error || 'Failed to create order');
      }
      if (result?.success) {
        const orderId = result?.data?.order?.orderId;
        const paymentUrl = result?.data?.payment?.paymentUrl;
        if (paymentUrl) {
          try { await Linking.openURL(paymentUrl); } catch {}
          Alert.alert('Order Created', `Order #${orderId}. Complete payment in the opened page.`);
        } else {
          Alert.alert('Order Placed', `Order #${orderId} placed successfully.`);
        }
        router.push('/(drawer)/marketplace');
      }
    } catch (e) {
      Alert.alert('Error', e?.message || 'Failed to place order');
    } finally {
      setLoading(false);
    }
  };

  if (loading && !refreshing) {
    return (
      <SafeAreaView style={styles.container}>
        <Header title="Checkout" />
        <View style={styles.centered}> 
          <ActivityIndicator size="large" color="#A68C7B" />
        </View>
      </SafeAreaView>
    );
  }

  return (
    <SafeAreaView style={styles.container}>
      <Header title="Checkout" />
      <ScrollView
        refreshControl={
          <RefreshControl refreshing={refreshing} onRefresh={onRefresh} colors={["#A68C7B"]} tintColor="#A68C7B" />
        }
        contentContainerStyle={[styles.content, { paddingBottom: (styles.content.padding || 12) + insets.bottom + 40 }]}
        keyboardShouldPersistTaps="handled"
        keyboardDismissMode="on-drag"
      >
        <View style={styles.columns}>
          <View style={styles.leftCol}>
            <View style={styles.card}>
              <View style={styles.cardHeader}><Text style={styles.cardHeaderText}>Delivery Address</Text></View>
              <View style={styles.cardBody}>
                {savedAddresses.map(addr => (
                  <TouchableOpacity key={addr.userAddressId} style={[styles.addressItem, selectedAddress === addr.userAddressId && styles.addressItemSelected]} onPress={() => setSelectedAddress(addr.userAddressId)}>
                    <View style={styles.addressRadio}>
                      {selectedAddress === addr.userAddressId && <Ionicons name="checkmark" size={16} color="#fff" />}
                    </View>
                    <View style={styles.addressDetails}>
                      <View style={styles.addressRow}>
                        <Text style={styles.addressName}>{addr.fullName}</Text>
                        {addr.isDefault ? <Text style={styles.badge}>Default</Text> : null}
                        {addr.addressType ? <Text style={styles.badgeSecondary}>{addr.addressType}</Text> : null}
                      </View>
                      <Text style={styles.addressPhone}>{addr.phoneNumber || addr.phone}</Text>
                      <Text style={styles.addressText}>{addr.addressLine1}{addr.addressLine2 ? `, ${addr.addressLine2}` : ''}</Text>
                      <Text style={styles.addressText}>{addr.barangayName}, {addr.cityMunicipalityName}, {addr.provinceName} {addr.postalCode}</Text>
                      {addr.landmark ? <Text style={styles.addressLandmark}>Near: {addr.landmark}</Text> : null}
                    </View>
                  </TouchableOpacity>
                ))}
                <TouchableOpacity style={styles.buttonSecondary} onPress={() => setShowAddressModal(true)}> 
                  <Ionicons name="add" size={18} color="#fff" />
                  <Text style={styles.buttonSecondaryText}>Add New Address</Text>
                </TouchableOpacity>
              </View>
            </View>

            <View style={styles.card}>
              <View style={styles.cardHeader}><Text style={styles.cardHeaderText}>Shipping Method</Text></View>
              <View style={styles.cardBody}>
                {shippingOptions.map(opt => (
                  <TouchableOpacity key={opt.id} style={[styles.optionItem, selectedShipping === opt.id && styles.optionItemSelected]} onPress={() => setSelectedShipping(opt.id)}>
                    <View style={styles.optionRadio}>
                      {selectedShipping === opt.id && <Ionicons name="checkmark" size={16} color="#fff" />}
                    </View>
                    <View style={styles.optionDetails}>
                      <Text style={styles.optionName}>{opt.name}</Text>
                      <Text style={styles.optionDesc}>{opt.description}</Text>
                    </View>
                    <Text style={styles.optionPrice}>₱{opt.price.toFixed(2)}</Text>
                  </TouchableOpacity>
                ))}
              </View>
            </View>

            <View style={styles.card}>
              <View style={styles.cardHeader}><Text style={styles.cardHeaderText}>Payment Method</Text></View>
              <View style={styles.cardBody}>
                {paymentMethods.map(m => (
                  <TouchableOpacity key={m.id} style={[styles.optionItem, selectedPayment === m.id && styles.optionItemSelected]} onPress={() => setSelectedPayment(m.id)}>
                    <View style={styles.optionRadio}>
                      {selectedPayment === m.id && <Ionicons name="checkmark" size={16} color="#fff" />}
                    </View>
                    <View style={styles.optionDetails}>
                      <Text style={styles.optionName}>{m.name}</Text>
                      <Text style={styles.optionDesc}>{m.description}</Text>
                    </View>
                  </TouchableOpacity>
                ))}
              </View>
              {selectedPayment === 'card' && (
                <View style={styles.cardBody}>
                  <View style={styles.formGroup}>
                    <Text style={styles.label}>Card Number</Text>
                    <TextInput style={styles.input} placeholder="1234 5678 9012 3456" keyboardType="number-pad" />
                  </View>
                  <View style={styles.formRow}>
                    <View style={[styles.formGroup, { flex: 1, marginRight: 8 }]}>
                      <Text style={styles.label}>Expiry Date</Text>
                      <TextInput style={styles.input} placeholder="MM/YY" />
                    </View>
                    <View style={[styles.formGroup, { flex: 1, marginLeft: 8 }]}>
                      <Text style={styles.label}>CVV</Text>
                      <TextInput style={styles.input} placeholder="123" keyboardType="number-pad" secureTextEntry />
                    </View>
                  </View>
                  <View style={styles.formGroup}>
                    <Text style={styles.label}>Cardholder Name</Text>
                    <TextInput style={styles.input} placeholder="John Doe" />
                  </View>
                </View>
              )}
            </View>

            <View style={styles.card}>
              <View style={styles.cardHeader}><Text style={styles.cardHeaderText}>Order Notes (Optional)</Text></View>
              <View style={styles.cardBody}>
                <TextInput
                  style={styles.textarea}
                  placeholder="Add any special instructions for your order..."
                  value={orderNotes}
                  onChangeText={setOrderNotes}
                  multiline
                  numberOfLines={4}
                  textAlignVertical="top"
                />
              </View>
            </View>
          </View>

          <View style={styles.rightCol}>
            <View style={styles.card}>
              <View style={styles.cardHeader}><Text style={styles.cardHeaderText}>Order Summary</Text></View>
              <View style={styles.cardBody}>
                {cartItems.map(item => (
                  <View key={item.id} style={styles.summaryItem}>
                    <View style={{ flex: 1 }}>
                      <Text style={styles.summaryTitle}>{item.title}</Text>
                      <Text style={styles.summarySub}>by {item.artist}</Text>
                      <Text style={styles.summaryQty}>Qty: {item.quantity}</Text>
                    </View>
                    <Text style={styles.summaryPrice}>₱{(Number(item.price || 0) * Number(item.quantity || 0)).toFixed(2)}</Text>
                  </View>
                ))}
                <View style={styles.divider} />
                <View style={styles.totalRow}><Text style={styles.totalLabel}>Subtotal</Text><Text style={styles.totalValue}>₱{getSubtotal().toFixed(2)}</Text></View>
                <View style={styles.totalRow}><Text style={styles.totalLabel}>Shipping</Text><Text style={styles.totalValue}>₱{getShippingCost().toFixed(2)}</Text></View>
                <View style={[styles.totalRow, styles.totalRowFinal]}><Text style={styles.totalFinalLabel}>Total</Text><Text style={styles.totalFinalValue}>₱{getTotal().toFixed(2)}</Text></View>
              </View>
              <TouchableOpacity style={styles.buttonPrimary} onPress={placeOrder} disabled={loading}>
                {loading ? (
                  <ActivityIndicator size="small" color="#fff" />
                ) : (
                  <>
                    <Text style={styles.buttonPrimaryText}>Place Order</Text>
                    <Ionicons name="arrow-forward" size={18} color="#fff" />
                  </>
                )}
              </TouchableOpacity>
            </View>
          </View>
        </View>
        {/* Bottom spacer so the last buttons are not obscured by Android nav bar */}
        <View style={{ height: insets.bottom + 24 }} />
      </ScrollView>
      {/* Address Modal */}
      <Modal visible={showAddressModal} animationType="slide" transparent onRequestClose={() => setShowAddressModal(false)}>
        <View style={styles.modalOverlay}>
          <View style={styles.modalCard}>
            <View style={styles.modalHeader}>
              <Text style={styles.modalTitle}>Add New Address</Text>
              <TouchableOpacity onPress={() => setShowAddressModal(false)}>
                <Ionicons name="close" size={22} color="#333" />
              </TouchableOpacity>
            </View>

            <ScrollView style={{ maxHeight: '85%' }} contentContainerStyle={{ paddingBottom: 16 }} nestedScrollEnabled>
              {/* Personal Information */}
              <Text style={styles.sectionTitle}>Personal Information</Text>
              <View style={styles.formGroup}>
                <Text style={styles.label}>Full Name *</Text>
                <TextInput style={styles.input} value={formData.fullName} onChangeText={(t)=>setFormData(p=>({...p, fullName:t}))} placeholder="Juan Dela Cruz" />
              </View>
              <View style={styles.formRow}>
                <View style={[styles.formGroup, { flex: 1, marginRight: 8 }]}>
                  <Text style={styles.label}>Email *</Text>
                  <TextInput style={styles.input} value={formData.email} onChangeText={(t)=>setFormData(p=>({...p, email:t}))} placeholder="juan@example.com" keyboardType="email-address" />
                </View>
                <View style={[styles.formGroup, { flex: 1, marginLeft: 8 }]}>
                  <Text style={styles.label}>Phone Number *</Text>
                  <TextInput style={styles.input} value={formData.phoneNumber} onChangeText={(t)=>setFormData(p=>({...p, phoneNumber:t}))} placeholder="09123456789" keyboardType="phone-pad" />
                </View>
              </View>

              {/* Address Details */}
              <Text style={styles.sectionTitle}>Address Details</Text>
              <View style={styles.formGroup}>
                <Text style={styles.label}>House/Unit No., Building, Street Name *</Text>
                <TextInput style={styles.input} value={formData.addressLine1} onChangeText={(t)=>setFormData(p=>({...p, addressLine1:t}))} placeholder="123 Main St, Unit 4B" />
              </View>
              <View style={styles.formGroup}>
                <Text style={styles.label}>Subdivision/Village/Building (Optional)</Text>
                <TextInput style={styles.input} value={formData.addressLine2} onChangeText={(t)=>setFormData(p=>({...p, addressLine2:t}))} placeholder="Green Valley Subd." />
              </View>
              <View style={styles.formGroup}>
                <Text style={styles.label}>Landmark (Optional)</Text>
                <TextInput style={styles.input} value={formData.landmark} onChangeText={(t)=>setFormData(p=>({...p, landmark:t}))} placeholder="Near ABC Store" />
              </View>

              {/* Location */}
              <Text style={styles.sectionTitle}>Location</Text>
              {/* Region */}
              <View style={styles.selectGroup}>
                <Text style={styles.label}>Region *</Text>
                <View style={styles.selectBox}>
                  <TouchableOpacity style={styles.selectTrigger} onPress={()=>setOpenSelect(s=>({...s, region: !s.region}))}>
                    <Text style={styles.selectTriggerText}>
                      {regions.find(r=>r.code===formData.regionCode)?.name || 'Select Region'}
                    </Text>
                    <Ionicons name={openSelect.region ? 'chevron-up' : 'chevron-down'} size={18} color="#666" />
                  </TouchableOpacity>
                  {openSelect.region && (
                    <FlatList
                      data={regions}
                      keyExtractor={(item) => String(item.code)}
                      renderItem={({ item }) => (
                        <TouchableOpacity style={[styles.selectItem, formData.regionCode===item.code && styles.selectItemActive]} onPress={()=>onSelectRegion(item.code)}>
                          <Text style={styles.selectItemText}>{item.name}</Text>
                        </TouchableOpacity>
                      )}
                      style={{ maxHeight: 260 }}
                      nestedScrollEnabled
                      showsVerticalScrollIndicator
                    />
                  )}
                </View>
              </View>
              {/* Province */}
              <View style={styles.selectGroup}>
                <Text style={styles.label}>Province *</Text>
                <View style={styles.selectBox}>
                  <TouchableOpacity style={styles.selectTrigger} onPress={()=>setOpenSelect(s=>({...s, province: !s.province}))}>
                    <Text style={styles.selectTriggerText}>
                      {provinces.find(p=>p.code===formData.provinceCode)?.name || 'Select Province'}
                    </Text>
                    <Ionicons name={openSelect.province ? 'chevron-up' : 'chevron-down'} size={18} color="#666" />
                  </TouchableOpacity>
                  {openSelect.province && (
                    <FlatList
                      data={provinces}
                      keyExtractor={(item) => String(item.code)}
                      renderItem={({ item }) => (
                        <TouchableOpacity style={[styles.selectItem, formData.provinceCode===item.code && styles.selectItemActive]} onPress={()=>onSelectProvince(item.code)}>
                          <Text style={styles.selectItemText}>{item.name}</Text>
                        </TouchableOpacity>
                      )}
                      style={{ maxHeight: 260 }}
                      nestedScrollEnabled
                      showsVerticalScrollIndicator
                    />
                  )}
                </View>
              </View>
              {/* City/Municipality */}
              <View style={styles.selectGroup}>
                <Text style={styles.label}>City/Municipality *</Text>
                <View style={styles.selectBox}>
                  <TouchableOpacity style={styles.selectTrigger} onPress={()=>setOpenSelect(s=>({...s, city: !s.city}))}>
                    <Text style={styles.selectTriggerText}>
                      {citiesMunicipalities.find(c=>c.code===formData.cityMunicipalityCode)?.name || 'Select City/Municipality'}
                    </Text>
                    <Ionicons name={openSelect.city ? 'chevron-up' : 'chevron-down'} size={18} color="#666" />
                  </TouchableOpacity>
                  {openSelect.city && (
                    <FlatList
                      data={citiesMunicipalities}
                      keyExtractor={(item) => String(item.code)}
                      renderItem={({ item }) => (
                        <TouchableOpacity style={[styles.selectItem, formData.cityMunicipalityCode===item.code && styles.selectItemActive]} onPress={()=>onSelectCity(item.code)}>
                          <Text style={styles.selectItemText}>{item.name}</Text>
                        </TouchableOpacity>
                      )}
                      style={{ maxHeight: 260 }}
                      nestedScrollEnabled
                      showsVerticalScrollIndicator
                    />
                  )}
                </View>
              </View>
              {/* Barangay */}
              <View style={styles.selectGroup}>
                <Text style={styles.label}>Barangay *</Text>
                <View style={styles.selectBox}>
                  <TouchableOpacity style={styles.selectTrigger} onPress={()=>setOpenSelect(s=>({...s, barangay: !s.barangay}))}>
                    <Text style={styles.selectTriggerText}>
                      {barangays.find(b=>b.code===formData.barangayCode)?.name || 'Select Barangay'}
                    </Text>
                    <Ionicons name={openSelect.barangay ? 'chevron-up' : 'chevron-down'} size={18} color="#666" />
                  </TouchableOpacity>
                  {openSelect.barangay && (
                    <FlatList
                      data={barangays}
                      keyExtractor={(item) => String(item.code)}
                      renderItem={({ item }) => (
                        <TouchableOpacity style={[styles.selectItem, formData.barangayCode===item.code && styles.selectItemActive]} onPress={()=>onSelectBarangay(item.code)}>
                          <Text style={styles.selectItemText}>{item.name}</Text>
                        </TouchableOpacity>
                      )}
                      style={{ maxHeight: 260 }}
                      nestedScrollEnabled
                      showsVerticalScrollIndicator
                    />
                  )}
                </View>
              </View>

              {/* Additional Options */}
              <Text style={styles.sectionTitle}>Additional Options</Text>
              <View style={styles.formRow}>
                {['home','office','other'].map(val => (
                  <TouchableOpacity key={val} style={[styles.typeChip, formData.addressType===val && styles.typeChipActive]} onPress={()=>setFormData(p=>({...p, addressType: val}))}>
                    <Text style={[styles.typeChipText, formData.addressType===val && styles.typeChipTextActive]}>
                      {val.charAt(0).toUpperCase()+val.slice(1)}
                    </Text>
                  </TouchableOpacity>
                ))}
              </View>
              <View style={styles.formGroup}>
                <Text style={styles.label}>Postal Code *</Text>
                <TextInput style={styles.input} value={formData.postalCode} onChangeText={(t)=>setFormData(p=>({...p, postalCode:t}))} keyboardType="number-pad" maxLength={4} placeholder="1234" />
              </View>
              <View style={styles.formGroup}>
                <Text style={styles.label}>Delivery Instructions (Optional)</Text>
                <TextInput style={styles.textarea} value={formData.deliveryInstructions} onChangeText={(t)=>setFormData(p=>({...p, deliveryInstructions:t}))} multiline numberOfLines={3} placeholder="Any special delivery instructions..." />
              </View>
            </ScrollView>

            <View style={styles.modalFooter}>
              <TouchableOpacity style={[styles.buttonSecondary, { flex: 1, backgroundColor: '#666' }]} onPress={()=>setShowAddressModal(false)} disabled={isSubmitting || formLoading}>
                <Text style={styles.buttonSecondaryText}>Cancel</Text>
              </TouchableOpacity>
              <View style={{ width: 10 }} />
              <TouchableOpacity style={[styles.buttonPrimary, { flex: 1 }]} onPress={saveAddress} disabled={isSubmitting || formLoading}>
                {isSubmitting ? <ActivityIndicator size="small" color="#fff" /> : <Text style={styles.buttonPrimaryText}>Save Address</Text>}
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: '#fff' },
  content: { padding: 12 },
  centered: { flex: 1, justifyContent: 'center', alignItems: 'center' },
  columns: { flexDirection: 'column' },
  leftCol: { flex: 1 },
  rightCol: { flex: 1, marginTop: 12 },
  card: { backgroundColor: '#fff', borderRadius: 10, borderWidth: 1, borderColor: '#eee', marginBottom: 12, overflow: 'hidden' },
  cardHeader: { paddingHorizontal: 14, paddingVertical: 12, borderBottomWidth: 1, borderBottomColor: '#eee' },
  cardHeaderText: { fontSize: 16, fontWeight: '700', color: '#333' },
  cardBody: { padding: 14 },
  addressItem: { flexDirection: 'row', padding: 12, borderWidth: 1, borderColor: '#eee', borderRadius: 10, marginBottom: 10, alignItems: 'flex-start' },
  addressItemSelected: { borderColor: '#A68C7B', backgroundColor: '#F5F3F0' },
  addressRadio: { width: 22, height: 22, borderRadius: 11, backgroundColor: '#A68C7B', alignItems: 'center', justifyContent: 'center', marginRight: 10 },
  addressDetails: { flex: 1 },
  addressRow: { flexDirection: 'row', alignItems: 'center', flexWrap: 'wrap', gap: 6 },
  addressName: { fontSize: 14, fontWeight: '700', color: '#333', marginRight: 8 },
  badge: { backgroundColor: '#d4b48a', color: '#fff', paddingHorizontal: 6, paddingVertical: 2, borderRadius: 8, overflow: 'hidden', marginLeft: 6, fontSize: 12 },
  badgeSecondary: { backgroundColor: '#eee', color: '#333', paddingHorizontal: 6, paddingVertical: 2, borderRadius: 8, overflow: 'hidden', marginLeft: 6, fontSize: 12 },
  addressPhone: { color: '#666', marginTop: 2 },
  addressText: { color: '#444', marginTop: 2 },
  addressLandmark: { color: '#666', marginTop: 2 },
  optionItem: { flexDirection: 'row', alignItems: 'center', padding: 12, borderWidth: 1, borderColor: '#eee', borderRadius: 10, marginBottom: 10 },
  optionItemSelected: { borderColor: '#A68C7B', backgroundColor: '#F5F3F0' },
  optionRadio: { width: 22, height: 22, borderRadius: 11, backgroundColor: '#A68C7B', alignItems: 'center', justifyContent: 'center', marginRight: 10 },
  optionDetails: { flex: 1 },
  optionName: { fontSize: 14, fontWeight: '600', color: '#333' },
  optionDesc: { fontSize: 12, color: '#777', marginTop: 2 },
  optionPrice: { fontWeight: '700', color: '#333' },
  formGroup: { marginBottom: 10 },
  formRow: { flexDirection: 'row' },
  label: { fontSize: 12, color: '#666', marginBottom: 4 },
  input: { borderWidth: 1, borderColor: '#eee', borderRadius: 8, paddingHorizontal: 12, paddingVertical: 10, backgroundColor: '#fafafa' },
  textarea: { borderWidth: 1, borderColor: '#eee', borderRadius: 8, paddingHorizontal: 12, paddingVertical: 10, minHeight: 100, backgroundColor: '#fafafa' },
  summaryItem: { flexDirection: 'row', alignItems: 'flex-start', justifyContent: 'space-between', marginBottom: 10 },
  summaryTitle: { fontSize: 14, fontWeight: '600', color: '#333' },
  summarySub: { fontSize: 12, color: '#777', marginTop: 2 },
  summaryQty: { fontSize: 12, color: '#666', marginTop: 2 },
  summaryPrice: { fontWeight: '700', color: '#333', marginLeft: 8 },
  divider: { height: 1, backgroundColor: '#eee', marginVertical: 10 },
  totalRow: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 6 },
  totalLabel: { color: '#666' },
  totalValue: { color: '#333' },
  totalRowFinal: { marginTop: 6 },
  totalFinalLabel: { fontWeight: '700', color: '#333' },
  totalFinalValue: { fontWeight: '800', color: '#333' },
  buttonPrimary: { backgroundColor: '#A68C7B', paddingVertical: 14, alignItems: 'center', justifyContent: 'center', flexDirection: 'row', gap: 8 },
  buttonPrimaryText: { color: '#fff', fontWeight: '700', marginRight: 6 },
  buttonSecondary: { backgroundColor: '#A68C7B', paddingVertical: 10, borderRadius: 8, alignItems: 'center', justifyContent: 'center', flexDirection: 'row', gap: 6 },
  buttonSecondaryText: { color: '#fff', fontWeight: '700', marginLeft: 6 },
  // Modal styles
  modalOverlay: { flex: 1, backgroundColor: 'rgba(0,0,0,0.4)', padding: 16, justifyContent: 'center' },
  modalCard: { backgroundColor: '#fff', borderRadius: 12, padding: 14, maxHeight: '92%' },
  modalHeader: { flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8 },
  modalTitle: { fontSize: 18, fontWeight: '700', color: '#333' },
  modalFooter: { flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginTop: 8 },
  sectionTitle: { fontSize: 14, fontWeight: '700', color: '#333', marginTop: 8, marginBottom: 6 },
  selectGroup: { marginBottom: 8 },
  selectBox: { borderWidth: 1, borderColor: '#eee', borderRadius: 8, padding: 6, backgroundColor: '#fafafa' },
  selectTrigger: { flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingVertical: 10, paddingHorizontal: 8, borderRadius: 6 },
  selectTriggerText: { color: '#333', flex: 1, marginRight: 8 },
  selectItem: { paddingVertical: 10, paddingHorizontal: 8, borderRadius: 6 },
  selectItemActive: { backgroundColor: '#F5F3F0' },
  selectItemText: { color: '#333' },
  typeChip: { paddingVertical: 8, paddingHorizontal: 12, borderRadius: 16, borderWidth: 1, borderColor: '#ddd', marginRight: 8 },
  typeChipActive: { backgroundColor: '#F5F3F0', borderColor: '#A68C7B' },
  typeChipText: { color: '#555' },
  typeChipTextActive: { color: '#A68C7B', fontWeight: '700' },
});

export default CheckoutScreen;
