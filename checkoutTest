import React, { useState, useEffect } from 'react';
import { StyleSheet, View, Text, SafeAreaView, ScrollView, TouchableOpacity, TextInput, ActivityIndicator, Alert, Modal, KeyboardAvoidingView, Platform } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useRouter } from 'expo-router';
import { Picker } from '@react-native-picker/picker';
import Header from '../components/Header';
import { useUser } from '../contexts/UserContext';
import { supabase } from '../../supabase/supabaseClient';

const CheckoutScreen = () => {
  const router = useRouter();
  const { userData } = useUser();
  
  // API configuration
  const API_BASE = "http://192.168.18.22:3000/api";
  
  // State management
  const [cartItems, setCartItems] = useState([]);
  const [savedAddresses, setSavedAddresses] = useState([]);
  const [selectedAddress, setSelectedAddress] = useState(null);
  const [selectedShipping, setSelectedShipping] = useState('standard');
  const [selectedPayment, setSelectedPayment] = useState('card');
  const [orderNotes, setOrderNotes] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const [loading, setLoading] = useState(true);
  const [accessToken, setAccessToken] = useState(null);
  const [refreshToken, setRefreshToken] = useState(null);
  
  // Address Modal State
  const [showAddressModal, setShowAddressModal] = useState(false);
  const [isSubmittingAddress, setIsSubmittingAddress] = useState(false);
  
  // Address Form Data
  const [addressForm, setAddressForm] = useState({
    fullName: '',
    email: '',
    phoneNumber: '',
    addressLine1: '',
    addressLine2: '',
    landmark: '',
    regionCode: '',
    provinceCode: '',
    cityMunicipalityCode: '',
    barangayCode: '',
    regionName: '',
    provinceName: '',
    cityMunicipalityName: '',
    barangayName: '',
    postalCode: '',
    addressType: 'Home',
    isDefault: false,
  });
  
  // PSGC Data States
  const [regions, setRegions] = useState([]);
  const [provinces, setProvinces] = useState([]);
  const [citiesMunicipalities, setCitiesMunicipalities] = useState([]);
  const [barangays, setBarangays] = useState([]);
  const [loadingLocations, setLoadingLocations] = useState(false);
  
  // Shipping options
  const shippingOptions = [
    {
      id: 'standard',
      name: 'Standard Shipping',
      description: '5-7 business days',
      price: 100,
      icon: 'car-outline',
    },
    {
      id: 'express',
      name: 'Express Shipping',
      description: '2-3 business days',
      price: 250,
      icon: 'flash-outline',
    },
    {
      id: 'priority',
      name: 'Priority Shipping',
      description: 'Next business day',
      price: 500,
      icon: 'rocket-outline',
    },
  ];
  
  // Payment methods
  const paymentMethods = [
    {
      id: 'card',
      name: 'Credit/Debit Card',
      description: 'Visa, Mastercard, Amex',
      icon: 'card-outline',
    },
    {
      id: 'gcash',
      name: 'GCash',
      description: 'Digital wallet payment',
      icon: 'wallet-outline',
    },
    {
      id: 'bank',
      name: 'Bank Transfer',
      description: 'Direct bank payment',
      icon: 'business-outline',
    },
    {
      id: 'cod',
      name: 'Cash on Delivery',
      description: 'Pay when you receive',
      icon: 'cash-outline',
    },
  ];
  
  // Fetch cart from backend
  const fetchCart = async (at, rt) => {
    try {
      const res = await fetch(`${API_BASE}/marketplace/cart`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Cookie': `access_token=${at || ''}; refresh_token=${rt || ''}`,
        },
      });

      if (!res.ok) {
        console.warn('[checkout.js] Failed to fetch cart:', res.status);
        router.replace('/(drawer)/marketplace');
        return;
      }

      const result = await res.json();
      if (result.success && result.data?.items) {
        if (result.data.items.length === 0) {
          Alert.alert('Empty Cart', 'Your cart is empty. Please add items before checkout.');
          router.replace('/(drawer)/marketplace');
          return;
        }
        
        const transformedCart = result.data.items.map(item => ({
          id: item.cartItemId,
          cartItemId: item.cartItemId,
          marketItemId: item.marketplace_items?.marketItemId,
          title: item.marketplace_items?.title || 'Unknown',
          price: item.marketplace_items?.price || 0,
          quantity: item.quantity,
          image: item.marketplace_items?.images?.[0] || null,
          artist: item.marketplace_items?.sellerProfiles?.shopName || 'Unknown Shop',
          sellerId: item.marketplace_items?.userId,
          sellerProfileId: item.marketplace_items?.sellerProfileId,
        }));
        setCartItems(transformedCart);
      } else {
        router.replace('/(drawer)/marketplace');
      }
    } catch (e) {
      console.warn('[checkout.js] Error fetching cart:', e?.message || e);
      router.replace('/(drawer)/marketplace');
    }
  };
  
  // Fetch addresses from backend
  const fetchAddresses = async (at, rt) => {
    try {
      const res = await fetch(`${API_BASE}/marketplace/addresses`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Cookie': `access_token=${at || ''}; refresh_token=${rt || ''}`,
        },
      });

      if (!res.ok) {
        console.warn('[checkout.js] Failed to fetch addresses:', res.status);
        return;
      }

      const result = await res.json();
      if (result.success && result.data) {
        setSavedAddresses(result.data);
        
        // Set default address if exists
        const defaultAddr = result.data.find(addr => addr.isDefault);
        if (defaultAddr) {
          setSelectedAddress(defaultAddr.userAddressId);
        } else if (result.data.length > 0) {
          setSelectedAddress(result.data[0].userAddressId);
        }
      }
    } catch (e) {
      console.warn('[checkout.js] Error fetching addresses:', e?.message || e);
    }
  };
  
  // Fetch Regions from PSGC API
  const fetchRegions = async () => {
    try {
      setLoadingLocations(true);
      const response = await fetch('https://psgc.gitlab.io/api/regions/');
      const data = await response.json();
      setRegions(data);
    } catch (error) {
      console.error('Error fetching regions:', error);
      Alert.alert('Error', 'Failed to load regions. Please try again.');
    } finally {
      setLoadingLocations(false);
    }
  };
  
  // Fetch Provinces
  const fetchProvinces = async (regionCode) => {
    try {
      setLoadingLocations(true);
      const response = await fetch(`https://psgc.gitlab.io/api/regions/${regionCode}/provinces/`);
      const data = await response.json();
      setProvinces(data);
    } catch (error) {
      console.error('Error fetching provinces:', error);
      Alert.alert('Error', 'Failed to load provinces. Please try again.');
    } finally {
      setLoadingLocations(false);
    }
  };
  
  // Fetch Cities/Municipalities
  const fetchCitiesMunicipalities = async (provinceCode) => {
    try {
      setLoadingLocations(true);
      const response = await fetch(`https://psgc.gitlab.io/api/provinces/${provinceCode}/cities-municipalities/`);
      const data = await response.json();
      setCitiesMunicipalities(data);
    } catch (error) {
      console.error('Error fetching cities:', error);
      Alert.alert('Error', 'Failed to load cities. Please try again.');
    } finally {
      setLoadingLocations(false);
    }
  };
  
  // Fetch Barangays
  const fetchBarangays = async (cityMunicipalityCode) => {
    try {
      setLoadingLocations(true);
      const response = await fetch(`https://psgc.gitlab.io/api/cities-municipalities/${cityMunicipalityCode}/barangays/`);
      const data = await response.json();
      setBarangays(data);
    } catch (error) {
      console.error('Error fetching barangays:', error);
      Alert.alert('Error', 'Failed to load barangays. Please try again.');
    } finally {
      setLoadingLocations(false);
    }
  };
  
  // Handle region change
  useEffect(() => {
    if (addressForm.regionCode) {
      fetchProvinces(addressForm.regionCode);
      setAddressForm(prev => ({
        ...prev,
        provinceCode: '',
        cityMunicipalityCode: '',
        barangayCode: '',
      }));
      setCitiesMunicipalities([]);
      setBarangays([]);
    }
  }, [addressForm.regionCode]);
  
  // Handle province change
  useEffect(() => {
    if (addressForm.provinceCode) {
      fetchCitiesMunicipalities(addressForm.provinceCode);
      setAddressForm(prev => ({
        ...prev,
        cityMunicipalityCode: '',
        barangayCode: '',
      }));
      setBarangays([]);
    }
  }, [addressForm.provinceCode]);
  
  // Handle city change
  useEffect(() => {
    if (addressForm.cityMunicipalityCode) {
      fetchBarangays(addressForm.cityMunicipalityCode);
      setAddressForm(prev => ({
        ...prev,
        barangayCode: '',
      }));
    }
  }, [addressForm.cityMunicipalityCode]);
  
  // Open address modal
  const handleOpenAddressModal = () => {
    // Pre-fill with user data
    if (userData) {
      setAddressForm(prev => ({
        ...prev,
        fullName: `${userData.firstName || ''} ${userData.lastName || ''}`.trim(),
        email: userData.email || '',
      }));
    }
    fetchRegions();
    setShowAddressModal(true);
  };
  
  // Handle address form input change
  const handleAddressInputChange = (field, value) => {
    setAddressForm(prev => ({
      ...prev,
      [field]: value,
    }));
  };
  
  // Validate address form
  const validateAddressForm = () => {
    if (!addressForm.fullName.trim()) {
      Alert.alert('Validation Error', 'Full name is required');
      return false;
    }
    if (!addressForm.email.trim() || !/\S+@\S+\.\S+/.test(addressForm.email)) {
      Alert.alert('Validation Error', 'Valid email is required');
      return false;
    }
    if (!addressForm.phoneNumber.trim()) {
      Alert.alert('Validation Error', 'Phone number is required');
      return false;
    }
    if (!addressForm.addressLine1.trim()) {
      Alert.alert('Validation Error', 'Street address is required');
      return false;
    }
    if (!addressForm.regionCode) {
      Alert.alert('Validation Error', 'Region is required');
      return false;
    }
    if (!addressForm.provinceCode) {
      Alert.alert('Validation Error', 'Province is required');
      return false;
    }
    if (!addressForm.cityMunicipalityCode) {
      Alert.alert('Validation Error', 'City/Municipality is required');
      return false;
    }
    if (!addressForm.barangayCode) {
      Alert.alert('Validation Error', 'Barangay is required');
      return false;
    }
    if (!addressForm.postalCode.trim() || !/^\d{4}$/.test(addressForm.postalCode)) {
      Alert.alert('Validation Error', 'Valid 4-digit postal code is required');
      return false;
    }
    return true;
  };
  
  // Submit address
  const handleSubmitAddress = async () => {
    if (!validateAddressForm()) {
      return;
    }
    
    setIsSubmittingAddress(true);
    
    try {
      // Get location names
      const selectedRegion = regions.find(r => r.code === addressForm.regionCode);
      const selectedProvince = provinces.find(p => p.code === addressForm.provinceCode);
      const selectedCity = citiesMunicipalities.find(c => c.code === addressForm.cityMunicipalityCode);
      const selectedBarangay = barangays.find(b => b.code === addressForm.barangayCode);
      
      const addressData = {
        ...addressForm,
        regionName: selectedRegion?.name || '',
        provinceName: selectedProvince?.name || '',
        cityMunicipalityName: selectedCity?.name || '',
        barangayName: selectedBarangay?.name || '',
      };
      
      // Save to backend
      const res = await fetch(`${API_BASE}/marketplace/addresses`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Cookie': `access_token=${accessToken}; refresh_token=${refreshToken}`,
        },
        body: JSON.stringify(addressData),
      });
      
      const result = await res.json();
      
      if (!res.ok) {
        throw new Error(result.error || 'Failed to save address');
      }
      
      if (result.success) {
        Alert.alert('Success', 'Address saved successfully!');
        
        // Refresh addresses
        await fetchAddresses(accessToken, refreshToken);
        
        // Reset form and close modal
        resetAddressForm();
        setShowAddressModal(false);
      }
    } catch (error) {
      console.error('Error saving address:', error);
      Alert.alert('Error', error.message || 'Failed to save address. Please try again.');
    } finally {
      setIsSubmittingAddress(false);
    }
  };
  
  // Reset address form
  const resetAddressForm = () => {
    setAddressForm({
      fullName: '',
      email: '',
      phoneNumber: '',
      addressLine1: '',
      addressLine2: '',
      landmark: '',
      regionCode: '',
      provinceCode: '',
      cityMunicipalityCode: '',
      barangayCode: '',
      regionName: '',
      provinceName: '',
      cityMunicipalityName: '',
      barangayName: '',
      postalCode: '',
      addressType: 'Home',
      isDefault: false,
    });
    setRegions([]);
    setProvinces([]);
    setCitiesMunicipalities([]);
    setBarangays([]);
  };
  
  // Initialize and fetch data
  useEffect(() => {
    const initAndFetch = async () => {
      if (!userData) {
        Alert.alert('Login Required', 'Please login to proceed with checkout.');
        router.replace('/(auth)/login');
        return;
      }
      
      const { data } = await supabase.auth.getSession();
      const at = data?.session?.access_token || null;
      const rt = data?.session?.refresh_token || null;
      setAccessToken(at);
      setRefreshToken(rt);
      
      await Promise.all([
        fetchCart(at, rt),
        fetchAddresses(at, rt),
      ]);
      
      setLoading(false);
    };

    initAndFetch();
  }, [userData]);
  
  // Calculations
  const getSubtotal = () => {
    return cartItems.reduce((total, item) => total + (item.price * item.quantity), 0);
  };
  
  const getShippingCost = () => {
    const option = shippingOptions.find(opt => opt.id === selectedShipping);
    return option ? option.price : 0;
  };
  
  const getTotal = () => {
    return getSubtotal() + getShippingCost();
  };
  
  // Handle place order
  const handlePlaceOrder = async () => {
    if (!selectedAddress) {
      Alert.alert('Address Required', 'Please select a delivery address');
      return;
    }
    
    setIsProcessing(true);
    
    try {
      // Get selected address details
      const address = savedAddresses.find(addr => addr.userAddressId === selectedAddress);
      
      // Prepare order data
      const orderData = {
        shipping_address: {
          fullName: address.fullName,
          phone: address.phoneNumber || address.phone,
          street: address.addressLine1 || address.street,
          barangay: address.barangayName || address.barangay,
          city: address.cityMunicipalityName || address.city,
          province: address.provinceName || address.province,
          postalCode: address.postalCode,
          landmark: address.landmark || '',
        },
        contact_info: {
          name: `${userData?.firstName || ''} ${userData?.lastName || ''}`.trim(),
          email: userData?.email,
          phone: address.phoneNumber || address.phone,
        },
        payment_method: selectedPayment,
        shipping_method: selectedShipping,
        order_notes: orderNotes,
      };
      
      // Create order via API
      const res = await fetch(`${API_BASE}/marketplace/orders/create`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Cookie': `access_token=${accessToken}; refresh_token=${refreshToken}`,
        },
        body: JSON.stringify(orderData),
      });
      
      const result = await res.json();
      
      if (!res.ok) {
        throw new Error(result.error || 'Failed to create order');
      }
      
      if (result.success) {
        const orderId = result.data.order?.orderId || 'N/A';
        
        Alert.alert(
          'Order Placed Successfully!',
          `Order #${orderId}\n\nThank you for your purchase!`,
          [
            {
              text: 'View Orders',
              onPress: () => {
                // Navigate to orders page (you'll need to create this)
                router.replace('/(drawer)/marketplace');
              },
            },
          ]
        );
      }
    } catch (error) {
      console.error('Error placing order:', error);
      Alert.alert('Order Failed', error.message || 'Failed to place order. Please try again.');
    } finally {
      setIsProcessing(false);
    }
  };
  
  // Loading state
  if (loading) {
    return (
      <SafeAreaView style={styles.container}>
        <Header title="Checkout" showSearch={false} />
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="large" color="#A68C7B" />
          <Text style={styles.loadingText}>Loading checkout...</Text>
        </View>
      </SafeAreaView>
    );
  }
  
  return (
    <SafeAreaView style={styles.container}>
      <Header title="Checkout" showSearch={false} />
      
      <ScrollView showsVerticalScrollIndicator={false}>
        {/* Delivery Address Section */}
        <View style={styles.section}>
          <View style={styles.sectionHeader}>
            <Ionicons name="location-outline" size={24} color="#A68C7B" />
            <Text style={styles.sectionTitle}>Delivery Address</Text>
          </View>
          
          {savedAddresses.length === 0 ? (
            <View style={styles.emptyState}>
              <Ionicons name="home-outline" size={48} color="#ccc" />
              <Text style={styles.emptyText}>No saved addresses</Text>
              <TouchableOpacity style={styles.addButton} onPress={handleOpenAddressModal}>
                <Ionicons name="add-circle-outline" size={20} color="#A68C7B" />
                <Text style={styles.addButtonText}>Add New Address</Text>
              </TouchableOpacity>
            </View>
          ) : (
            <>
              {savedAddresses.map((addr) => (
                <TouchableOpacity
                  key={addr.userAddressId}
                  style={[
                    styles.addressCard,
                    selectedAddress === addr.userAddressId && styles.addressCardSelected,
                  ]}
                  onPress={() => setSelectedAddress(addr.userAddressId)}
                >
                  <View style={styles.radioButton}>
                    {selectedAddress === addr.userAddressId && (
                      <View style={styles.radioButtonInner} />
                    )}
                  </View>
                  <View style={styles.addressDetails}>
                    <View style={styles.addressNameRow}>
                      <Text style={styles.addressName}>{addr.fullName}</Text>
                      {addr.isDefault && (
                        <View style={styles.defaultBadge}>
                          <Text style={styles.defaultBadgeText}>Default</Text>
                        </View>
                      )}
                    </View>
                    <Text style={styles.addressPhone}>{addr.phoneNumber}</Text>
                    <Text style={styles.addressText}>
                      {addr.addressLine1}
                      {addr.addressLine2 && `, ${addr.addressLine2}`}
                    </Text>
                    <Text style={styles.addressLocation}>
                      {addr.barangayName}, {addr.cityMunicipalityName}, {addr.provinceName} {addr.postalCode}
                    </Text>
                    {addr.landmark && (
                      <Text style={styles.addressLandmark}>Near: {addr.landmark}</Text>
                    )}
                  </View>
                </TouchableOpacity>
              ))}
              
              <TouchableOpacity style={styles.addAddressButton} onPress={handleOpenAddressModal}>
                <Ionicons name="add-circle-outline" size={20} color="#A68C7B" />
                <Text style={styles.addAddressButtonText}>Add New Address</Text>
              </TouchableOpacity>
            </>
          )}
        </View>
        
        {/* Shipping Method Section */}
        <View style={styles.section}>
          <View style={styles.sectionHeader}>
            <Ionicons name="car-outline" size={24} color="#A68C7B" />
            <Text style={styles.sectionTitle}>Shipping Method</Text>
          </View>
          
          {shippingOptions.map((option) => (
            <TouchableOpacity
              key={option.id}
              style={[
                styles.optionCard,
                selectedShipping === option.id && styles.optionCardSelected,
              ]}
              onPress={() => setSelectedShipping(option.id)}
            >
              <View style={styles.radioButton}>
                {selectedShipping === option.id && (
                  <View style={styles.radioButtonInner} />
                )}
              </View>
              <Ionicons name={option.icon} size={24} color="#666" style={styles.optionIcon} />
              <View style={styles.optionDetails}>
                <Text style={styles.optionName}>{option.name}</Text>
                <Text style={styles.optionDescription}>{option.description}</Text>
              </View>
              <Text style={styles.optionPrice}>M{option.price}</Text>
            </TouchableOpacity>
          ))}
        </View>
        
        {/* Payment Method Section */}
        <View style={styles.section}>
          <View style={styles.sectionHeader}>
            <Ionicons name="card-outline" size={24} color="#A68C7B" />
            <Text style={styles.sectionTitle}>Payment Method</Text>
          </View>
          
          {paymentMethods.map((method) => (
            <TouchableOpacity
              key={method.id}
              style={[
                styles.optionCard,
                selectedPayment === method.id && styles.optionCardSelected,
              ]}
              onPress={() => setSelectedPayment(method.id)}
            >
              <View style={styles.radioButton}>
                {selectedPayment === method.id && (
                  <View style={styles.radioButtonInner} />
                )}
              </View>
              <Ionicons name={method.icon} size={24} color="#666" style={styles.optionIcon} />
              <View style={styles.optionDetails}>
                <Text style={styles.optionName}>{method.name}</Text>
                <Text style={styles.optionDescription}>{method.description}</Text>
              </View>
            </TouchableOpacity>
          ))}
        </View>
        
        {/* Order Notes Section */}
        <View style={styles.section}>
          <View style={styles.sectionHeader}>
            <Ionicons name="document-text-outline" size={24} color="#A68C7B" />
            <Text style={styles.sectionTitle}>Order Notes (Optional)</Text>
          </View>
          
          <TextInput
            style={styles.notesInput}
            placeholder="Add any special instructions for your order..."
            placeholderTextColor="#999"
            value={orderNotes}
            onChangeText={setOrderNotes}
            multiline
            numberOfLines={4}
            textAlignVertical="top"
          />
        </View>
        
        {/* Order Summary Section */}
        <View style={styles.summarySection}>
          <Text style={styles.summaryTitle}>Order Summary</Text>
          
          {cartItems.map((item) => (
            <View key={item.id} style={styles.summaryItem}>
              <View style={styles.summaryItemDetails}>
                <Text style={styles.summaryItemTitle} numberOfLines={1}>
                  {item.title}
                </Text>
                <Text style={styles.summaryItemArtist}>by {item.artist}</Text>
                <Text style={styles.summaryItemQuantity}>Qty: {item.quantity}</Text>
              </View>
              <Text style={styles.summaryItemPrice}>
                M{(item.price * item.quantity).toLocaleString()}
              </Text>
            </View>
          ))}
          
          <View style={styles.summaryTotals}>
            <View style={styles.summaryRow}>
              <Text style={styles.summaryLabel}>Subtotal</Text>
              <Text style={styles.summaryValue}>M{getSubtotal().toLocaleString()}</Text>
            </View>
            <View style={styles.summaryRow}>
              <Text style={styles.summaryLabel}>Shipping</Text>
              <Text style={styles.summaryValue}>M{getShippingCost().toLocaleString()}</Text>
            </View>
            <View style={[styles.summaryRow, styles.summaryRowTotal]}>
              <Text style={styles.summaryLabelTotal}>Total</Text>
              <Text style={styles.summaryValueTotal}>M{getTotal().toLocaleString()}</Text>
            </View>
          </View>
        </View>
        
        {/* Place Order Button */}
        <View style={styles.buttonContainer}>
          <TouchableOpacity
            style={[styles.placeOrderButton, isProcessing && styles.placeOrderButtonDisabled]}
            onPress={handlePlaceOrder}
            disabled={isProcessing}
          >
            {isProcessing ? (
              <>
                <ActivityIndicator size="small" color="#fff" style={{ marginRight: 8 }} />
                <Text style={styles.placeOrderButtonText}>Processing...</Text>
              </>
            ) : (
              <Text style={styles.placeOrderButtonText}>Place Order</Text>
            )}
          </TouchableOpacity>
        </View>
        
        {/* Bottom spacing */}
        <View style={{ height: 30 }} />
      </ScrollView>
      
      {/* Address Modal */}
      <Modal
        visible={showAddressModal}
        animationType="slide"
        transparent={false}
        onRequestClose={() => {
          resetAddressForm();
          setShowAddressModal(false);
        }}
      >
        <SafeAreaView style={styles.modalContainer}>
          <KeyboardAvoidingView
            behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
            style={{ flex: 1 }}
          >
            {/* Modal Header */}
            <View style={styles.modalHeader}>
              <TouchableOpacity
                onPress={() => {
                  resetAddressForm();
                  setShowAddressModal(false);
                }}
              >
                <Ionicons name="close" size={28} color="#333" />
              </TouchableOpacity>
              <Text style={styles.modalTitle}>Add New Address</Text>
              <View style={{ width: 28 }} />
            </View>
            
            <ScrollView style={styles.modalContent} showsVerticalScrollIndicator={false}>
              {/* Personal Information */}
              <View style={styles.formSection}>
                <Text style={styles.formSectionTitle}>Personal Information</Text>
                
                <View style={styles.formGroup}>
                  <Text style={styles.formLabel}>Full Name *</Text>
                  <TextInput
                    style={styles.formInput}
                    value={addressForm.fullName}
                    onChangeText={(value) => handleAddressInputChange('fullName', value)}
                    placeholder="Juan Dela Cruz"
                    placeholderTextColor="#999"
                  />
                </View>
                
                <View style={styles.formGroup}>
                  <Text style={styles.formLabel}>Email *</Text>
                  <TextInput
                    style={styles.formInput}
                    value={addressForm.email}
                    onChangeText={(value) => handleAddressInputChange('email', value)}
                    placeholder="juan@example.com"
                    placeholderTextColor="#999"
                    keyboardType="email-address"
                    autoCapitalize="none"
                  />
                </View>
                
                <View style={styles.formGroup}>
                  <Text style={styles.formLabel}>Phone Number *</Text>
                  <TextInput
                    style={styles.formInput}
                    value={addressForm.phoneNumber}
                    onChangeText={(value) => handleAddressInputChange('phoneNumber', value)}
                    placeholder="+63 912 345 6789"
                    placeholderTextColor="#999"
                    keyboardType="phone-pad"
                  />
                </View>
              </View>
              
              {/* Address Details */}
              <View style={styles.formSection}>
                <Text style={styles.formSectionTitle}>Address Details</Text>
                
                <View style={styles.formGroup}>
                  <Text style={styles.formLabel}>House/Unit No., Building, Street *</Text>
                  <TextInput
                    style={styles.formInput}
                    value={addressForm.addressLine1}
                    onChangeText={(value) => handleAddressInputChange('addressLine1', value)}
                    placeholder="123 Main Street, Unit 4B"
                    placeholderTextColor="#999"
                  />
                </View>
                
                <View style={styles.formGroup}>
                  <Text style={styles.formLabel}>Subdivision/Village (Optional)</Text>
                  <TextInput
                    style={styles.formInput}
                    value={addressForm.addressLine2}
                    onChangeText={(value) => handleAddressInputChange('addressLine2', value)}
                    placeholder="Green Valley Subdivision"
                    placeholderTextColor="#999"
                  />
                </View>
                
                <View style={styles.formGroup}>
                  <Text style={styles.formLabel}>Landmark (Optional)</Text>
                  <TextInput
                    style={styles.formInput}
                    value={addressForm.landmark}
                    onChangeText={(value) => handleAddressInputChange('landmark', value)}
                    placeholder="Near ABC Store"
                    placeholderTextColor="#999"
                  />
                </View>
              </View>
              
              {/* Location */}
              <View style={styles.formSection}>
                <Text style={styles.formSectionTitle}>Location</Text>
                
                <View style={styles.formGroup}>
                  <Text style={styles.formLabel}>Region *</Text>
                  <View style={styles.pickerContainer}>
                    <Picker
                      selectedValue={addressForm.regionCode}
                      onValueChange={(value) => handleAddressInputChange('regionCode', value)}
                      enabled={!loadingLocations}
                      style={styles.picker}
                    >
                      <Picker.Item label="Select Region" value="" />
                      {regions.map((region) => (
                        <Picker.Item key={region.code} label={region.name} value={region.code} />
                      ))}
                    </Picker>
                  </View>
                </View>
                
                <View style={styles.formGroup}>
                  <Text style={styles.formLabel}>Province *</Text>
                  <View style={styles.pickerContainer}>
                    <Picker
                      selectedValue={addressForm.provinceCode}
                      onValueChange={(value) => handleAddressInputChange('provinceCode', value)}
                      enabled={!!addressForm.regionCode && !loadingLocations}
                      style={styles.picker}
                    >
                      <Picker.Item label="Select Province" value="" />
                      {provinces.map((province) => (
                        <Picker.Item key={province.code} label={province.name} value={province.code} />
                      ))}
                    </Picker>
                  </View>
                </View>
                
                <View style={styles.formGroup}>
                  <Text style={styles.formLabel}>City/Municipality *</Text>
                  <View style={styles.pickerContainer}>
                    <Picker
                      selectedValue={addressForm.cityMunicipalityCode}
                      onValueChange={(value) => handleAddressInputChange('cityMunicipalityCode', value)}
                      enabled={!!addressForm.provinceCode && !loadingLocations}
                      style={styles.picker}
                    >
                      <Picker.Item label="Select City/Municipality" value="" />
                      {citiesMunicipalities.map((city) => (
                        <Picker.Item key={city.code} label={city.name} value={city.code} />
                      ))}
                    </Picker>
                  </View>
                </View>
                
                <View style={styles.formGroup}>
                  <Text style={styles.formLabel}>Barangay *</Text>
                  <View style={styles.pickerContainer}>
                    <Picker
                      selectedValue={addressForm.barangayCode}
                      onValueChange={(value) => handleAddressInputChange('barangayCode', value)}
                      enabled={!!addressForm.cityMunicipalityCode && !loadingLocations}
                      style={styles.picker}
                    >
                      <Picker.Item label="Select Barangay" value="" />
                      {barangays.map((barangay) => (
                        <Picker.Item key={barangay.code} label={barangay.name} value={barangay.code} />
                      ))}
                    </Picker>
                  </View>
                </View>
                
                <View style={styles.formGroup}>
                  <Text style={styles.formLabel}>Postal Code *</Text>
                  <TextInput
                    style={styles.formInput}
                    value={addressForm.postalCode}
                    onChangeText={(value) => handleAddressInputChange('postalCode', value)}
                    placeholder="1234"
                    placeholderTextColor="#999"
                    keyboardType="number-pad"
                    maxLength={4}
                  />
                </View>
              </View>
              
              {/* Additional Options */}
              <View style={styles.formSection}>
                <Text style={styles.formSectionTitle}>Additional Options</Text>
                
                <View style={styles.formGroup}>
                  <Text style={styles.formLabel}>Address Type</Text>
                  <View style={styles.radioGroup}>
                    <TouchableOpacity
                      style={styles.radioOption}
                      onPress={() => handleAddressInputChange('addressType', 'Home')}
                    >
                      <View style={styles.radioButton}>
                        {addressForm.addressType === 'Home' && (
                          <View style={styles.radioButtonInner} />
                        )}
                      </View>
                      <Text style={styles.radioLabel}>Home</Text>
                    </TouchableOpacity>
                    
                    <TouchableOpacity
                      style={styles.radioOption}
                      onPress={() => handleAddressInputChange('addressType', 'Work')}
                    >
                      <View style={styles.radioButton}>
                        {addressForm.addressType === 'Work' && (
                          <View style={styles.radioButtonInner} />
                        )}
                      </View>
                      <Text style={styles.radioLabel}>Work</Text>
                    </TouchableOpacity>
                    
                    <TouchableOpacity
                      style={styles.radioOption}
                      onPress={() => handleAddressInputChange('addressType', 'Other')}
                    >
                      <View style={styles.radioButton}>
                        {addressForm.addressType === 'Other' && (
                          <View style={styles.radioButtonInner} />
                        )}
                      </View>
                      <Text style={styles.radioLabel}>Other</Text>
                    </TouchableOpacity>
                  </View>
                </View>
                
                <TouchableOpacity
                  style={styles.checkboxOption}
                  onPress={() => handleAddressInputChange('isDefault', !addressForm.isDefault)}
                >
                  <View style={styles.checkbox}>
                    {addressForm.isDefault && (
                      <Ionicons name="checkmark" size={16} color="#A68C7B" />
                    )}
                  </View>
                  <Text style={styles.checkboxLabel}>Set as default address</Text>
                </TouchableOpacity>
              </View>
              
              {/* Bottom spacing */}
              <View style={{ height: 20 }} />
            </ScrollView>
            
            {/* Modal Actions */}
            <View style={styles.modalActions}>
              <TouchableOpacity
                style={styles.modalCancelButton}
                onPress={() => {
                  resetAddressForm();
                  setShowAddressModal(false);
                }}
                disabled={isSubmittingAddress}
              >
                <Text style={styles.modalCancelButtonText}>Cancel</Text>
              </TouchableOpacity>
              
              <TouchableOpacity
                style={[styles.modalSaveButton, isSubmittingAddress && styles.modalSaveButtonDisabled]}
                onPress={handleSubmitAddress}
                disabled={isSubmittingAddress}
              >
                {isSubmittingAddress ? (
                  <>
                    <ActivityIndicator size="small" color="#fff" style={{ marginRight: 8 }} />
                    <Text style={styles.modalSaveButtonText}>Saving...</Text>
                  </>
                ) : (
                  <Text style={styles.modalSaveButtonText}>Save Address</Text>
                )}
              </TouchableOpacity>
            </View>
          </KeyboardAvoidingView>
        </SafeAreaView>
      </Modal>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F5F8FA',
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    paddingVertical: 60,
  },
  loadingText: {
    marginTop: 12,
    fontSize: 14,
    color: '#666',
  },
  
  // Section Styles
  section: {
    backgroundColor: '#fff',
    marginHorizontal: 15,
    marginTop: 15,
    borderRadius: 10,
    padding: 15,
  },
  sectionHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 15,
    gap: 10,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  
  // Empty State
  emptyState: {
    alignItems: 'center',
    paddingVertical: 30,
  },
  emptyText: {
    fontSize: 16,
    color: '#999',
    marginTop: 10,
    marginBottom: 15,
  },
  addButton: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    paddingVertical: 10,
    paddingHorizontal: 20,
    backgroundColor: '#F5F0EB',
    borderRadius: 8,
  },
  addButtonText: {
    fontSize: 14,
    color: '#A68C7B',
    fontWeight: '600',
  },
  
  // Address Card
  addressCard: {
    flexDirection: 'row',
    padding: 15,
    backgroundColor: '#f9f9f9',
    borderRadius: 10,
    marginBottom: 10,
    borderWidth: 2,
    borderColor: '#e0e0e0',
  },
  addressCardSelected: {
    borderColor: '#A68C7B',
    backgroundColor: '#F5F0EB',
  },
  radioButton: {
    width: 20,
    height: 20,
    borderRadius: 10,
    borderWidth: 2,
    borderColor: '#A68C7B',
    marginRight: 12,
    alignItems: 'center',
    justifyContent: 'center',
  },
  radioButtonInner: {
    width: 10,
    height: 10,
    borderRadius: 5,
    backgroundColor: '#A68C7B',
  },
  addressDetails: {
    flex: 1,
  },
  addressNameRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 4,
    gap: 8,
  },
  addressName: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#333',
  },
  defaultBadge: {
    backgroundColor: '#FFD700',
    paddingHorizontal: 8,
    paddingVertical: 2,
    borderRadius: 4,
  },
  defaultBadgeText: {
    fontSize: 10,
    fontWeight: 'bold',
    color: '#333',
  },
  addressPhone: {
    fontSize: 14,
    color: '#666',
    marginBottom: 4,
  },
  addressText: {
    fontSize: 14,
    color: '#555',
    marginBottom: 2,
  },
  addressLocation: {
    fontSize: 14,
    color: '#555',
    marginBottom: 2,
  },
  addressLandmark: {
    fontSize: 13,
    color: '#999',
    fontStyle: 'italic',
  },
  addAddressButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 8,
    paddingVertical: 12,
    backgroundColor: '#F5F0EB',
    borderRadius: 8,
    marginTop: 5,
  },
  addAddressButtonText: {
    fontSize: 14,
    color: '#A68C7B',
    fontWeight: '600',
  },
  
  // Option Card (Shipping & Payment)
  optionCard: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 15,
    backgroundColor: '#f9f9f9',
    borderRadius: 10,
    marginBottom: 10,
    borderWidth: 2,
    borderColor: '#e0e0e0',
  },
  optionCardSelected: {
    borderColor: '#A68C7B',
    backgroundColor: '#F5F0EB',
  },
  optionIcon: {
    marginRight: 12,
  },
  optionDetails: {
    flex: 1,
  },
  optionName: {
    fontSize: 15,
    fontWeight: '600',
    color: '#333',
    marginBottom: 2,
  },
  optionDescription: {
    fontSize: 13,
    color: '#666',
  },
  optionPrice: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#A68C7B',
  },
  
  // Order Notes
  notesInput: {
    backgroundColor: '#f9f9f9',
    borderRadius: 10,
    padding: 12,
    fontSize: 14,
    color: '#333',
    borderWidth: 1,
    borderColor: '#e0e0e0',
    minHeight: 100,
  },
  
  // Order Summary
  summarySection: {
    backgroundColor: '#fff',
    marginHorizontal: 15,
    marginTop: 15,
    borderRadius: 10,
    padding: 15,
  },
  summaryTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
    marginBottom: 15,
  },
  summaryItem: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    paddingVertical: 10,
    borderBottomWidth: 1,
    borderBottomColor: '#f0f0f0',
  },
  summaryItemDetails: {
    flex: 1,
    marginRight: 10,
  },
  summaryItemTitle: {
    fontSize: 14,
    fontWeight: '600',
    color: '#333',
    marginBottom: 2,
  },
  summaryItemArtist: {
    fontSize: 12,
    color: '#666',
    marginBottom: 2,
  },
  summaryItemQuantity: {
    fontSize: 12,
    color: '#999',
  },
  summaryItemPrice: {
    fontSize: 14,
    fontWeight: 'bold',
    color: '#A68C7B',
  },
  summaryTotals: {
    marginTop: 15,
    paddingTop: 15,
    borderTopWidth: 1,
    borderTopColor: '#e0e0e0',
  },
  summaryRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 10,
  },
  summaryLabel: {
    fontSize: 14,
    color: '#666',
  },
  summaryValue: {
    fontSize: 14,
    fontWeight: '600',
    color: '#333',
  },
  summaryRowTotal: {
    marginTop: 5,
    paddingTop: 10,
    borderTopWidth: 1,
    borderTopColor: '#e0e0e0',
  },
  summaryLabelTotal: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  summaryValueTotal: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#A68C7B',
  },
  
  // Place Order Button
  buttonContainer: {
    marginHorizontal: 15,
    marginTop: 20,
  },
  placeOrderButton: {
    flexDirection: 'row',
    backgroundColor: '#A68C7B',
    paddingVertical: 16,
    borderRadius: 10,
    alignItems: 'center',
    justifyContent: 'center',
    shadowColor: '#A68C7B',
    shadowOpacity: 0.3,
    shadowOffset: { width: 0, height: 4 },
    shadowRadius: 8,
    elevation: 4,
  },
  placeOrderButtonDisabled: {
    opacity: 0.6,
  },
  placeOrderButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: 'bold',
  },
  
  // Modal Styles
  modalContainer: {
    flex: 1,
    backgroundColor: '#F5F8FA',
  },
  modalHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: 15,
    paddingVertical: 15,
    backgroundColor: '#fff',
    borderBottomWidth: 1,
    borderBottomColor: '#e0e0e0',
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  modalContent: {
    flex: 1,
    paddingHorizontal: 15,
  },
  formSection: {
    marginTop: 20,
  },
  formSectionTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#333',
    marginBottom: 15,
  },
  formGroup: {
    marginBottom: 15,
  },
  formLabel: {
    fontSize: 14,
    fontWeight: '600',
    color: '#555',
    marginBottom: 8,
  },
  formInput: {
    backgroundColor: '#fff',
    borderWidth: 1,
    borderColor: '#e0e0e0',
    borderRadius: 8,
    paddingHorizontal: 12,
    paddingVertical: 12,
    fontSize: 14,
    color: '#333',
  },
  pickerContainer: {
    backgroundColor: '#fff',
    borderWidth: 1,
    borderColor: '#e0e0e0',
    borderRadius: 8,
    overflow: 'hidden',
  },
  picker: {
    height: 50,
  },
  radioGroup: {
    flexDirection: 'row',
    gap: 15,
    marginTop: 8,
  },
  radioOption: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  radioLabel: {
    fontSize: 14,
    color: '#555',
  },
  checkboxOption: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 10,
    marginTop: 10,
  },
  checkbox: {
    width: 20,
    height: 20,
    borderWidth: 2,
    borderColor: '#A68C7B',
    borderRadius: 4,
    alignItems: 'center',
    justifyContent: 'center',
  },
  checkboxLabel: {
    fontSize: 14,
    color: '#555',
  },
  modalActions: {
    flexDirection: 'row',
    paddingHorizontal: 15,
    paddingVertical: 15,
    backgroundColor: '#fff',
    borderTopWidth: 1,
    borderTopColor: '#e0e0e0',
    gap: 10,
  },
  modalCancelButton: {
    flex: 1,
    paddingVertical: 14,
    borderRadius: 8,
    backgroundColor: '#f0f0f0',
    alignItems: 'center',
    justifyContent: 'center',
  },
  modalCancelButtonText: {
    fontSize: 16,
    fontWeight: '600',
    color: '#666',
  },
  modalSaveButton: {
    flex: 1,
    flexDirection: 'row',
    paddingVertical: 14,
    borderRadius: 8,
    backgroundColor: '#A68C7B',
    alignItems: 'center',
    justifyContent: 'center',
  },
  modalSaveButtonDisabled: {
    opacity: 0.6,
  },
  modalSaveButtonText: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#fff',
  },
});

export default CheckoutScreen;
